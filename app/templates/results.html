{% extends "base.html" %}

{% block title %}Analysis Results - MediScan AI{% endblock %}

{% block head %}
<style>
    .analysis-output {
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .diagnosis-output {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .diagnosis-output h2 {
        color: var(--medical-blue);
        font-size: 1.4rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    .diagnosis-output h3 {
        color: var(--medical-light-blue);
        font-size: 1.2rem;
        margin-top: 1.2rem;
        margin-bottom: 0.8rem;
    }
    
    .diagnosis-output ul, 
    .diagnosis-output ol {
        padding-left: 1.5rem;
    }
    
    .diagnosis-output strong {
        color: var(--medical-blue);
    }
    
    @media print {
        .analysis-output, .diagnosis-output {
            max-height: none;
            overflow: visible;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Analysis Results</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1><i class="fas fa-file-medical-alt me-2"></i>Medical Image Analysis Report</h1>
            <div class="d-flex gap-2">
                <a href="{{ url_for('main.index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-plus me-1"></i>New Analysis
                </a>
                <button class="btn btn-outline-secondary" onclick="window.print()">
                    <i class="fas fa-print me-1"></i>Print
                </button>
            </div>
        </div>
        
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Educational Purpose Only:</strong> This analysis is for research and educational 
            purposes. The results should not be used for clinical decisions or to replace professional 
            medical advice.
        </div>
        
        {% if not results.is_likely_xray %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            <strong>Warning:</strong> The uploaded image does not appear to be a standard medical X-ray. 
            The analysis may be significantly less accurate.
        </div>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header primary-header">
                <h3 class="card-title mb-0"><i class="fas fa-image me-2"></i>X-ray Image</h3>
            </div>
            <div class="card-body p-0">
                <div class="medical-image-container">
                    <img src="{{ url_for('static', filename='uploads/' + results.image_filename) }}" 
                         class="img-fluid" alt="Uploaded X-ray Image">
                </div>
                <div class="p-3">
                    <div class="mb-2">
                        <strong><i class="fas fa-file-alt me-2"></i>Filename:</strong> 
                        <span class="text-monospace">{{ results.image_filename }}</span>
                    </div>
                    <div class="mb-2">
                        <strong><i class="fas fa-calendar-alt me-2"></i>Date Analyzed:</strong> 
                        <span>{{ now.strftime('%B %d, %Y') }}</span>
                    </div>
                    <div>
                        <strong><i class="fas fa-clock me-2"></i>Time:</strong> 
                        <span>{{ now.strftime('%H:%M:%S') }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header primary-header">
                <h3 class="card-title mb-0"><i class="fas fa-user-md me-2"></i>Patient Information</h3>
            </div>
            <div class="card-body">
                <h5><i class="fas fa-clipboard-list me-2"></i>Reported Symptoms:</h5>
                <div class="card mb-4 bg-light">
                    <div class="card-body">
                        {% if results.symptoms %}
                            <p>{{ results.symptoms }}</p>
                        {% else %}
                            <p class="text-muted">No symptoms provided.</p>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-body p-3">
                                <h6 class="card-title mb-2"><i class="fas fa-vial me-2"></i>Quick Stats</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Analysis Type:</span>
                                    <span class="badge bg-primary">Chest X-ray</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>AI Models Used:</span>
                                    <span class="badge bg-info">2</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Processing Time:</span>
                                    <span class="badge bg-success">{{ processing_time|default('25s') }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body p-3">
                                <h6 class="card-title mb-2"><i class="fas fa-info-circle me-2"></i>Analysis Info</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Image Type:</span>
                                    <span class="badge {% if results.is_likely_xray %}bg-success{% else %}bg-danger{% endif %}">
                                        {% if results.is_likely_xray %}X-ray Confirmed{% else %}Not X-ray{% endif %}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Image Quality:</span>
                                    <span class="badge bg-primary">Standard</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Version:</span>
                                    <span class="badge bg-secondary">v2.0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 mb-4">
        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="report-tab" data-bs-toggle="tab" data-bs-target="#report" type="button" role="tab" aria-controls="report" aria-selected="true">
                    <i class="fas fa-file-medical me-2"></i>Medical Report
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab" aria-controls="analysis" aria-selected="false">
                    <i class="fas fa-microscope me-2"></i>Raw Analysis
                </button>
            </li>
        </ul>
        
        <div class="card shadow-sm tab-content">
            <div class="tab-pane fade show active" id="report" role="tabpanel" aria-labelledby="report-tab">
                <div class="card-header success-header">
                    <h3 class="card-title mb-0"><i class="fas fa-stethoscope me-2"></i>AI-Assisted Medical Assessment</h3>
                </div>
                <div class="card-body">
                    <div class="diagnosis-output markdown-content" id="diagnosis-content">{{ results.diagnosis | safe }}</div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="analysis" role="tabpanel" aria-labelledby="analysis-tab">
                <div class="card-header secondary-header">
                    <h3 class="card-title mb-0"><i class="fas fa-search me-2"></i>Technical Analysis Results</h3>
                </div>
                <div class="card-body">
                    <pre class="analysis-output">{{ results.analysis }}</pre>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-header primary-header">
                <h3 class="card-title mb-0"><i class="fas fa-cog me-2"></i>Actions</h3>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print Results
                    </button>
                    <button class="btn btn-success" id="downloadPDF">
                        <i class="fas fa-file-pdf me-2"></i>Download PDF
                    </button>
                    <a href="{{ url_for('main.index') }}" class="btn btn-info">
                        <i class="fas fa-plus-circle me-2"></i>New Analysis
                    </a>
                    <button class="btn btn-secondary" id="compareBtn">
                        <i class="fas fa-columns me-2"></i>Compare with Previous
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // PDF Download button
        document.getElementById('downloadPDF').addEventListener('click', function() {
            alert('PDF generation feature would be implemented here. This would create a downloadable PDF report of the analysis.');
        });
        
        // Compare button
        document.getElementById('compareBtn').addEventListener('click', function() {
            alert('Comparison feature would be implemented here. This would allow comparing with previous analyses.');
        });
    });
</script>
{% endblock %}